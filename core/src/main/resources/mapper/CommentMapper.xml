<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wiblog.mapper.CommentMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.wiblog.entity.Comment">
            <id column="id" property="id"/>
            <result column="uid" property="uid"/>
            <result column="article_id" property="articleId"/>
            <result column="gen_id" property="genId"/>
            <result column="parent_id" property="parentId"/>
            <result column="likes" property="likes"/>
            <result column="floor" property="floor"/>
            <result column="content" property="content"/>
            <result column="state" property="state"/>
            <result column="create_time" property="createTime"/>
            <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
id, uid, article_id, parent_id,gen_id,floor, likes, content, state,create_time, update_time
    </sql>
    
    <select id="selectCommentPage" resultType="com.wiblog.vo.CommentVo">
        select c.*,u.username,u.avatar_img as avatarImg from comment as c
        join user as u on u.uid = c.uid
        where c.article_id = #{articleId} and c.gen_id = 0
    </select>

    <!--不设数量限制-->
    <select id="selectSubCommentLimit" resultType="com.wiblog.vo.SubCommentVo">
        select c1.*,
        u1.username as replyName,u1.avatar_img as replyAvatarImg,
        u2.uid as replyedId,u2.username as replyedName,u2.avatar_img as replyedAvatarImg
        from comment as c1
        join user as u1 on u1.uid = c1.uid and c1.gen_id = #{commentId}
        join comment as c2 on c2.id = c1.parent_id
        join user as u2 on u2.uid = c2.uid
        <choose>
            <when test="orderBy == 'asc'">
                ORDER BY c1.create_time asc
            </when>
            <otherwise>
                ORDER BY c1.create_time desc
            </otherwise>
        </choose>

    </select>
    
    <select id="selectCommentManagePage" resultType="com.wiblog.vo.CommentManageVo">
        select u.username,c.id,c.likes,c.content,c.state,c.article_id,c.create_time,count(c1.id) as reply_num from comment as c
        join user as u on c.uid = u.uid
        join article as a on c.article_id = a.id
        join comment as c1 on c1.parent_id = c.id
        <where>
            <if test="article_id != null">
                and c.article_id = #{articleId}
            </if>
            <if test="state != null">
                and c.state = #{state}
            </if>
            <if test="username != null">
                and u.username like "%"#{username}"%"
            </if>
            <if test="title != null">
                and a.title like "%"#{title}"%"
            </if>
        </where>
        group by c1.id
    </select>
</mapper>